Implement a solvent-subtraction step inside an existing FTIR spectral processing pipeline. Do not invent or prescribe new object names, classes, or data structures. Use whatever spectrum representation and metadata/provenance mechanisms already exist in the codebase, and extend them only if necessary and consistent with existing patterns.

The step operates on a preprocessed target spectrum that already exists in the pipeline. The solvent reference spectrum is also expected to be preprocessed upstream into a compatible state, meaning the axis definition, units, and preprocessing conventions match the target. The step must obtain the solvent reference either by requesting it from the user at runtime or by retrieving it from internal storage. Internal storage must support saving a solvent reference as a named entry and marking one or more entries as defaults, so the user can select a reference from a list without re-providing it. The storage record must include enough metadata to help select the right reference (at least a name and optional tags such as solvent identity, measurement mode, temperature, instrument, and date), and it must provide a stable identifier for reproducible reprocessing.

The fit domain must be the entire overlap of wavenumbers between target and reference, with no user-defined fit windows. Compute the overlap interval automatically, and if the two spectra are on slightly different x-grids, resample the reference onto the target grid using an interpolation method consistent with the codebase defaults. Do not extrapolate outside the overlap; mask or mark those regions explicitly and record the overlap limits and any masking in provenance.

Assume baseline/background removal has already been performed for both spectra before this step. Do not fit or subtract polynomial baseline terms. Do not introduce baseline correction implicitly. If the existing codebase requires a numerical stabilizer, allow an optional constant offset term only, disabled by default, and log its use explicitly.

Estimate the solvent contribution in the target using a linear model over the full overlap. For the default case of a single solvent reference spectrum r(x), fit a single scale factor k that minimizes the squared error between the target y(x) and k·r(x) over the overlap (optionally weighted if the pipeline already provides weights). Then subtract k·r(x) from the target to produce the corrected spectrum. Support an advanced mode where multiple stored solvent references can be used simultaneously as a basis set, fitting coefficients k_i in a linear combination Σ k_i·r_i(x) over the full overlap. If multi-reference fitting is enabled, include optional ridge regularization on the solvent coefficients to improve stability when references are correlated, and record the regularization settings and solver details.

Include wavenumber shift compensation because small axis misalignment creates derivative-like artifacts after subtraction. Enable shift compensation by default with conservative bounds. Implement shift fitting by scanning a small bounded shift range Δ, applying the shift to the reference via interpolation, refitting the linear coefficient(s) for each candidate Δ, and selecting the Δ that minimizes the residual error over the full overlap. Store the chosen shift, the search bounds, and step size (or optimizer settings if not using grid search) in provenance. Apply the same shift logic consistently for single-reference and multi-reference modes.

Outputs must include the corrected spectrum, the fitted solvent contribution, and fit diagnostics. Align all outputs to the target axis. Record full provenance including the solvent reference identifier(s), coefficient(s), shift, overlap interval, any resampling method, any weights use, any regularization settings, and the fit error metrics. Diagnostics must include at least SSE and RMSE over the overlap. Add warnings derived from diagnostics rather than silent “fixes.” Compute an oversubtraction indicator based on negative excursions in the corrected spectrum (for example, fraction of points below a negative threshold or integrated negative area) and expose it as a warning. Compute a derivative-like residual score by correlating the residual with the numerical derivative of the reference; a high score indicates misalignment or shape mismatch and should prompt a warning to verify the reference choice or expand the stored reference set. If multi-reference fitting is enabled, compute and report a stability metric such as condition number or similar, and warn on ill-conditioning.

The step must be deterministic and reproducible. Given the same target spectrum, the same stored reference(s), and the same parameters, it must produce identical outputs. Any optional behaviors (weights, regularization, non-negativity constraints, constant offset) must be explicit configuration options and must be logged when used. Create tests that generate synthetic targets as linear combinations of a solvent reference and a solute spectrum plus noise, verify correct recovery across scale changes and small shifts, and verify that incorrect reference selection triggers the diagnostics warnings.
